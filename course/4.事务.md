# MongoDB的事务

![transaction](../images/transactions.jpg)

关系型数据库对事务之间的关系是无法拆分的关系，提到关系型数据库最重要的解决的问题就是事务。MONGODB 之前被人一直无法在核心数据库上应用的时，被攻击的问题就是事务，事务中最重要的原子性，在MONGODB的多collection是无法被满足的。

在MongoDB中，对单个文档的操作是原子的。由于可以在单个文档结构中使用内嵌文档和数组来获得数据之间的关系，而不必跨多个文档和集合进行范式化，所以这种单文档原子性避免了许多实际场景中对多文档事务的需求。

然而，自从MongoDB 4.0之后，开始支持事务了。**在MongoDB中，事务是在多个文档级别执行的操作集合**。MongoDB 的事务支持主要体现在多文档操作的原子性上，即多个文档的修改要么全部生效，要么全部回滚，以保持数据的一致性。

在 MongoDB 中，事务仅支持在副本集成员或 mongos 实例上。事务需要使用副本集或分片集群来提供必要的事务保证。要在 MongoDB 中启用事务，你需要配置一个包含主节点、从节点（可选）和仲裁节点（可选）的副本集。一旦设置了副本集，你就可以在会话中启动事务。

但是需要注意的是：**事务操作会引起性能方面的消耗（greater performance）,并且不能因为有了事务，我们就把mongodb 当传统数据库使用，即使是传统数据库，大事务等等也是我们在使用中避免甚至对有些RDBMS是禁止的。**

MongoDB 的事务模型遵循了分布式事务的理念，可以应对分布式环境下的数据一致性需求。MongoDB 支持多个文档的事务操作，可以跨越多个集合和数据库，并保证事务的原子性、一致性、隔离性和持久性。通过使用事务，开发人员可以确保多个操作在一起执行，要么全部成功，要么全部失败。

值得注意的是，与关系型数据库相比，MongoDB的事务支持在一些方面有所限制。例如，MongoDB 的事务通常适用于单个副本集或分片集群中的事务，而不是在跨多个独立 MongoDB 实例的分布式事务。

## 事务的基本操作

在 MongoDB 中，要开启并执行事务，你需要使用事务会话（Transaction Session）。事务会话是用于在多个操作之间保持一致性的上下文。下面是一个示例，演示如何开启并执行事务：

```bash
session = db.getMongo().startSession();
session.startTransaction();
studentCollection = session.getDatabase("school").students;
accountCollection = session.getDatabase("school").accounts;
studentCollection.updateOne({name: "zhangsan"}, {$set: {age: 35}})
accountCollection.insetOne({name: "zhaoshang", moneny: 150})
session.commitTransaction();
session.endSession();
```

## 
